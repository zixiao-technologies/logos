name: Update VS Code Vendor

on:
  schedule:
    - cron: '0 6 * * 1' # weekly on Monday 06:00 UTC
  workflow_dispatch:
    inputs:
      ref:
        description: 'VS Code git ref to use (default: main)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout Logos
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 22.21.1
        uses: actions/setup-node@v4
        with:
          node-version: '22.21.1'

      - name: Enable Corepack
        run: corepack enable

      - name: Checkout VS Code
        uses: actions/checkout@v4
        with:
          repository: microsoft/vscode
          ref: ${{ inputs.ref || 'main' }}
          path: vscode-src
          fetch-depth: 1

      - name: Install VS Code build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libkrb5-dev

      - name: Sync VS Code vendor
        run: ./update.sh --source ./vscode-src --build

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore(vendor): update vscode out bundle'
          title: 'chore(vendor): update VS Code vendor'
          body: |
            Automated sync of VS Code out/ artifacts and extensionHostProcess.ts.
          branch: chore/update-vscode-vendor
          delete-branch: true
